<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComMarília - Player de Story com Swiper.js</title>
    
    <!-- Bibliotecas e Dependências Externas -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/pt-br.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* --- Configurações Globais --- */
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f8f9fa;
        }

        /* --- Estilos da Marca --- */
        .logo-text-com { color: #F4A261; }
        .logo-text-marilia { color: #1D3557; }

        /* --- Efeitos Visuais --- */
        .text-shadow { text-shadow: 1px 1px 4px rgba(0,0,0,0.6); }

        /* --- Lazy Loading Placeholder --- */
        img.lazy {
            background-color: #e2e8f0;
        }

        /* --- Animações e Transições do Menu Lateral --- */
        #side-menu {
            transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #side-menu.open {
            transform: translateX(0);
        }

        /* --- Efeito de Sobreposição para Cards --- */
        .news-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 40%, transparent 70%);
            transition: opacity 0.3s ease;
        }

        /* --- Animações e Transições do Player de Story --- */
        #story-viewer {
            transform: scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, visibility 0s 0.3s;
        }
        #story-viewer.open {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        /* --- Efeito de Sobreposição no Conteúdo do Story --- */
        .story-slide-content::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%);
            z-index: 1;
        }

        /* --- Barras de Progresso do Story --- */
        .progress-bar {
            flex: 1;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: white;
            transform-origin: left;
            transform: scaleX(0);
        }

        /* --- Animações e Transições do Modal --- */
        #story-modal {
            visibility: hidden;
            transition: visibility 0s 0.4s;
        }
        #story-modal-overlay {
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        #story-modal.open {
            visibility: visible;
            transition-delay: 0s;
        }
        #story-modal.open #story-modal-overlay {
            opacity: 1;
        }
        #story-modal-content {
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #story-modal.open #story-modal-content {
            transform: translateY(0);
        }

        /* --- Estilos para o conteúdo do Modal --- */
        .prose-styles h1, .prose-styles h2, .prose-styles h3 { margin-bottom: 0.5em; font-weight: 700; }
        .prose-styles p { margin-bottom: 1em; line-height: 1.7; }
        .prose-styles a { color: #2563eb; text-decoration: underline; }
        .prose-styles ul, .prose-styles ol { margin-left: 1.5em; margin-bottom: 1em; }
        .prose-styles li { margin-bottom: 0.5em; }
        .prose-styles blockquote { border-left: 4px solid #ccc; padding-left: 1em; margin-left: 0; font-style: italic; }

        /* --- Utilitário para Esconder Barra de Rolagem --- */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estilos específicos para o Swiper */
        .swiper-container-vertical {
            width: 100%;
            height: 100%;
        }
        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* --- ATUALIZAÇÃO: Estilo do Player de Story --- */
        .story-slide-content {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #111;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Em telas maiores (desktop), força a proporção 9:16 */
        @media (min-width: 640px) { /* Corresponde ao breakpoint 'sm' do Tailwind */
            .story-slide-content {
                width: auto; /* Deixa a altura e a proporção definirem a largura */
                height: 90vh; /* Usa 90% da altura da tela */
                max-height: 896px; /* Limite máximo de altura */
                aspect-ratio: 9 / 16; /* Força a proporção de um celular */
                border-radius: 0.75rem; /* Cantos arredondados */
            }
        }

        /* Previne que o Swiper capture eventos de clique em áreas interativas */
        .swiper-no-swiping {
             -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Menu Lateral -->
    <aside id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-[70] p-6 flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <div class="text-2xl font-black"><span class="logo-text-com">Com</span><span class="logo-text-marilia">Marília.</span></div>
            <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800" aria-label="Fechar menu"><i data-feather="x" class="w-6 h-6"></i></button>
        </div>
        <nav>
            <a href="#" class="block py-3 px-4 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 hover:text-gray-900">Página Inicial</a>
            <a href="#" class="block py-3 px-4 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 hover:text-gray-900">Marília</a>
            <a href="#" class="block py-3 px-4 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 hover:text-gray-900">Região</a>
            <a href="#" class="block py-3 px-4 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 hover:text-gray-900">Policial</a>
            <a href="#" class="block py-3 px-4 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 hover:text-gray-900">Brasil</a>
        </nav>
    </aside>
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden backdrop-blur-sm"></div>

    <!-- Cabeçalho Principal -->
    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center max-w-5xl">
            <button id="menu-btn" class="text-gray-600 hover:text-gray-900 focus:outline-none" aria-label="Abrir menu"><i data-feather="menu" class="w-6 h-6"></i></button>
            <div class="text-2xl font-black"><span class="logo-text-com">Com</span><span class="logo-text-marilia">Marília.</span></div>
            <button class="text-gray-600 hover:text-gray-900 focus:outline-none" aria-label="Perfil do usuário"><i data-feather="user" class="w-6 h-6"></i></button>
        </div>
    </header>

    <!-- Conteúdo Principal com os Cards de Notícias -->
    <main class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">Últimas Notícias</h1>
        <div id="news-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards de Notícias são gerados dinamicamente -->
        </div>
    </main>

    <!-- Player de Web Story (Refatorado com Swiper.js) -->
    <div id="story-viewer" class="fixed inset-0 bg-black z-50 flex items-center justify-center" role="dialog" aria-modal="true">
        <!-- Swiper Principal (Vertical - para navegar entre stories) -->
        <div class="swiper-container-vertical">
            <div class="swiper-wrapper" id="story-swiper-wrapper">
                <!-- Slides dos stories serão inseridos aqui pelo JS -->
            </div>
        </div>
    </div>

    <!-- Modal da Matéria Completa -->
     <div id="story-modal" class="fixed inset-0 z-[80] flex items-end sm:items-center sm:justify-center">
        <div id="story-modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div id="story-modal-content" class="relative bg-white w-full max-h-[90vh] sm:max-w-2xl rounded-t-2xl sm:rounded-2xl flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800"></h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-feather="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto hide-scrollbar">
                <img id="modal-image" src="" alt="" class="w-full h-auto rounded-lg mb-4 object-cover">
                <div id="modal-text" class="prose-styles text-gray-700"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configuração do Day.js para o português do Brasil
            dayjs.extend(dayjs_plugin_relativeTime);
            dayjs.locale('pt-br');

            class App {
                constructor() {
                    this.storiesData = [];
                    this.api = new Api();
                    this.ui = new UI();
                    this.storyPlayer = new StoryPlayer(
                        this.ui.getStoryPlayerDOM(),
                        () => this.storiesData
                    );
                }

                async init() {
                    try {
                        const rawData = await this.api.fetchPosts();
                        this.storiesData = rawData
                            .filter(story => {
                                const storyDate = new Date(story.timestamp);
                                const now = new Date();
                                return story.status === 'published' || (story.status === 'scheduled' && storyDate <= now);
                            })
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                        this.ui.renderNewsGrid(this.storiesData);
                        this.ui.initializeLazyLoading();
                        this.ui.setupEventListeners(
                            (storyIndex) => this.storyPlayer.open(storyIndex),
                            () => this.storyPlayer.closeModal() // Passa a função de fechar o modal
                        );
                        
                        // Renderiza a estrutura inicial do Swiper
                        this.storyPlayer.buildMainSwiper();

                        feather.replace();

                    } catch (error) {
                        console.error("Falha ao inicializar a aplicação:", error);
                        this.ui.displayError("Não foi possível carregar as notícias. Tente novamente mais tarde.");
                    }
                }
            }

            class Api {
                constructor() {
                    const SUPABASE_URL = 'https://apdaldrcyugyjiwpodel.supabase.co';
                    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZGFsZHJjeXVneWppd3BvZGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDc0NDAsImV4cCI6MjA3MTIyMzQ0MH0.UX0uAej52mEC3vsk-GSRHB7jNYm0N7MEN5-rBk-6e7A';
                    this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                async fetchPosts() {
                    const { data, error } = await this.supabase
                        .from('stories')
                        .select(`*, story_pages ( * )`)
                        .order('timestamp', { ascending: false });

                    if (error) {
                        throw new Error(`Erro ao buscar dados do Supabase: ${error.message}`);
                    }
                    
                    data.forEach(story => {
                        if (story.story_pages) {
                            story.story_pages.sort((a, b) => a.order_index - b.order_index);
                        }
                    });
                    return data;
                }
            }

            class UI {
                constructor() {
                    this.dom = {
                        newsGrid: document.getElementById('news-grid'),
                        menuBtn: document.getElementById('menu-btn'),
                        closeMenuBtn: document.getElementById('close-menu-btn'),
                        sideMenu: document.getElementById('side-menu'),
                        menuOverlay: document.getElementById('menu-overlay'),
                        closeModalBtn: document.getElementById('close-modal-btn'),
                        modalOverlay: document.getElementById('story-modal-overlay'),
                    };
                }

                renderNewsGrid(storiesData) {
                    if (!this.dom.newsGrid) return;
                    this.dom.newsGrid.innerHTML = storiesData.map((story, index) => `
                        <div class="news-card relative rounded-xl shadow-lg overflow-hidden cursor-pointer h-[480px] group" data-story-index="${index}" role="button" tabindex="0" aria-label="Abrir story: ${story.card_title}">
                            <img data-src="${story.card_image}" alt="${story.card_title}" class="lazy w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500 ease-in-out">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-5 text-white z-10">
                                <span class="text-white text-xs font-bold px-3 py-1 rounded-full" style="background-color: ${story.category_color};">${story.category}</span>
                                <h2 class="text-xl font-bold mt-2 leading-tight text-shadow">${story.card_title}</h2>
                            </div>
                        </div>
                    `).join('');
                }

                initializeLazyLoading() {
                    const lazyImages = document.querySelectorAll('img.lazy');
                    if ("IntersectionObserver" in window) {
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    const img = entry.target;
                                    img.src = img.dataset.src;
                                    img.classList.remove('lazy');
                                    observer.unobserve(img);
                                }
                            });
                        });
                        lazyImages.forEach(img => observer.observe(img));
                    } else {
                        lazyImages.forEach(img => img.src = img.dataset.src);
                    }
                }

                setupEventListeners(onCardClick, onCloseModal) {
                    this.dom.newsGrid?.addEventListener('click', (e) => {
                        const card = e.target.closest('.news-card');
                        if (card) onCardClick(parseInt(card.dataset.storyIndex));
                    });
                    this.dom.newsGrid?.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            const card = e.target.closest('.news-card');
                            if (card) { e.preventDefault(); onCardClick(parseInt(card.dataset.storyIndex)); }
                        }
                    });
                    const toggleMenu = () => {
                        const isOpen = this.dom.sideMenu.classList.toggle('open');
                        this.dom.menuOverlay.classList.toggle('hidden');
                        if (isOpen) this.dom.closeMenuBtn.focus();
                        else this.dom.menuBtn.focus();
                    };
                    this.dom.menuBtn?.addEventListener('click', toggleMenu);
                    this.dom.closeMenuBtn?.addEventListener('click', toggleMenu);
                    this.dom.menuOverlay?.addEventListener('click', toggleMenu);
                    
                    // Listeners do Modal
                    this.dom.closeModalBtn?.addEventListener('click', onCloseModal);
                    this.dom.modalOverlay?.addEventListener('click', onCloseModal);
                }
                
                getStoryPlayerDOM() {
                    return {
                        viewer: document.getElementById('story-viewer'),
                        mainSwiperWrapper: document.getElementById('story-swiper-wrapper'),
                        modal: document.getElementById('story-modal'),
                        modalImage: document.getElementById('modal-image'),
                        modalTitle: document.getElementById('modal-title'),
                        modalText: document.getElementById('modal-text'),
                    };
                }

                displayError(message) {
                    if (this.dom.newsGrid) {
                        this.dom.newsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">${message}</p>`;
                    }
                }
            }

            class StoryPlayer {
                constructor(dom, getStoriesCallback) {
                    this.dom = dom;
                    this.getStories = getStoriesCallback;
                    this.mainSwiper = null;
                    this.activeNestedSwiper = null;
                    this.progressTimeline = null;
                    this.isMuted = true;
                }

                buildMainSwiper() {
                    const stories = this.getStories();
                    this.dom.mainSwiperWrapper.innerHTML = stories.map((story, index) => `
                        <div class="swiper-slide" data-story-index="${index}">
                            <div class="story-slide-content">
                                <header class="absolute top-8 left-0 right-0 w-full px-4 flex justify-between items-center z-20">
                                    <div class="flex items-center gap-3">
                                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZHRoPSI0MCIgdmlld0JveD0iMCAwIDEwMCAxMDAiPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNGRkZGRkYiLz48dGV4dCB4PSI1MCIgeT0iNjgiIGZvbnQtZmFtaWx5PSJQb3BwaW5zLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQwIiBmb250LXdlaWdodD0iOTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj48dHNwYW4gZmlsbD0iI0Y0QTkyMSI+QzwvdHNwYW4+PHRzcGFuIGZpbGw9IiMxRDM1NTciPk08L3RzcGFuPjwvdGV4dD48L3N2Zz4=" class="w-10 h-10 rounded-full border-2 border-white/50">
                                        <div>
                                            <div class="font-bold text-white text-sm">ComMarília</div>
                                            <div class="story-time text-white/80 text-xs">${this.formatTimeAgo(story.timestamp)}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button class="mute-story-btn text-white bg-black/30 rounded-full p-2 hidden"><i data-feather="volume-2" class="w-6 h-6"></i></button>
                                        <button class="share-story-btn text-white bg-black/30 rounded-full p-2"><i data-feather="share-2" class="w-6 h-6"></i></button>
                                        <button class="close-story-btn text-white bg-black/30 rounded-full p-2"><i data-feather="x" class="w-6 h-6"></i></button>
                                    </div>
                                </header>
                                <div class="story-progress-container absolute top-2 left-0 w-full flex gap-1 px-2 z-20">
                                    ${story.story_pages.map(() => `<div class="progress-bar"><div class="progress-bar-inner"></div></div>`).join('')}
                                </div>
                                
                                <div class="swiper-container-horizontal w-full h-full">
                                    <div class="swiper-wrapper">
                                        ${story.story_pages.map(page => `
                                            <div class="swiper-slide">
                                                ${page.media_type === 'video'
                                                    ? `<video src="${page.media_url}" class="w-full h-full object-cover" playsinline loop></video>`
                                                    : `<img src="${page.media_url}" class="w-full h-full object-cover" />`
                                                }
                                                <div class="absolute bottom-24 left-0 p-6 text-white z-10 w-full">
                                                    <div class="text-2xl font-bold leading-tight text-shadow">${page.title}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                 <div class="full-story-swipe-up absolute bottom-10 left-0 w-full z-30 p-6 text-center cursor-pointer ${story.story_pages.some(p => p.show_full_link) ? '' : 'hidden'}">
                                    <div class="inline-flex flex-col items-center gap-1 text-white animate-bounce"><i data-feather="chevron-up" class="w-6 h-6"></i><span class="font-semibold text-sm">Matéria Completa</span></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    feather.replace();
                    this.setupGlobalEventListeners();
                }

                setupGlobalEventListeners() {
                    document.querySelectorAll('.close-story-btn').forEach(btn => btn.addEventListener('click', () => this.close()));
                    document.querySelectorAll('.share-story-btn').forEach(btn => btn.addEventListener('click', (e) => this.shareStory(e)));
                    document.querySelectorAll('.mute-story-btn').forEach(btn => btn.addEventListener('click', (e) => this.toggleMute(e)));
                    document.querySelectorAll('.full-story-swipe-up').forEach(btn => btn.addEventListener('click', (e) => this.openModal(e)));
                }

                open(storyIndex) {
                    this.dom.viewer.classList.add('open');
                    document.body.style.overflow = 'hidden';

                    if (!this.mainSwiper) {
                        this.mainSwiper = new Swiper('.swiper-container-vertical', {
                            direction: 'vertical',
                            initialSlide: storyIndex,
                            on: {
                                init: (swiper) => this.handleStoryChange(swiper),
                                slideChange: (swiper) => this.handleStoryChange(swiper),
                            },
                        });
                    } else {
                        this.mainSwiper.slideTo(storyIndex, 0);
                    }
                }

                close() {
                    this.dom.viewer.classList.remove('open');
                    document.body.style.overflow = '';
                    if (this.progressTimeline) this.progressTimeline.kill();
                    if (this.activeNestedSwiper) {
                         const video = this.activeNestedSwiper.slides[this.activeNestedSwiper.activeIndex]?.querySelector('video');
                         if(video) video.pause();
                    }
                    if (this.mainSwiper && !this.mainSwiper.destroyed) {
                        this.mainSwiper.destroy(true, true);
                        this.mainSwiper = null;
                    }
                }

                handleStoryChange(swiper) {
                    if (this.progressTimeline) this.progressTimeline.kill();
                    if (this.activeNestedSwiper && !this.activeNestedSwiper.destroyed) {
                        this.activeNestedSwiper.destroy(true, true);
                    }
                    
                    const activeStorySlide = swiper.slides[swiper.activeIndex];
                    const nestedSwiperContainer = activeStorySlide.querySelector('.swiper-container-horizontal');
                    
                    this.activeNestedSwiper = new Swiper(nestedSwiperContainer, {
                        allowTouchMove: false, 
                        on: {
                            init: (swiper) => this.startProgress(swiper),
                            slideChange: (swiper) => this.startProgress(swiper),
                        }
                    });

                    const storyContent = activeStorySlide.querySelector('.story-slide-content');
                    
                    // Lógica de clique para avançar/voltar
                    let pressTimer;
                    storyContent.onpointerdown = () => {
                        this.progressTimeline.pause();
                        const video = this.activeNestedSwiper.slides[this.activeNestedSwiper.activeIndex]?.querySelector('video');
                        if(video) video.pause();
                        pressTimer = setTimeout(() => { /* Lógica de manter pressionado pode ser adicionada aqui */ }, 200);
                    };

                    storyContent.onpointerup = (e) => {
                        clearTimeout(pressTimer);
                        this.progressTimeline.resume();
                        const video = this.activeNestedSwiper.slides[this.activeNestedSwiper.activeIndex]?.querySelector('video');
                        if(video) video.play();
                        
                        // Verifica se foi um clique rápido (não um arrastar ou manter pressionado)
                        const rect = e.currentTarget.getBoundingClientRect();
                        const clickX = e.clientX - rect.left;
                        if (clickX < rect.width / 3) {
                            this.activeNestedSwiper.slidePrev();
                        } else {
                            this.activeNestedSwiper.slideNext();
                        }
                    };
                }

                startProgress(swiper) {
                    if (this.progressTimeline) this.progressTimeline.kill();

                    const DURATION = 5; // 5 segundos por página
                    const progressBars = swiper.el.closest('.story-slide-content').querySelectorAll('.progress-bar-inner');
                    
                    this.progressTimeline = gsap.timeline({
                        onComplete: () => this.mainSwiper.slideNext()
                    });

                    progressBars.forEach((bar, index) => {
                        gsap.set(bar, { scaleX: 0 });
                        if (index < swiper.activeIndex) {
                            gsap.set(bar, { scaleX: 1 });
                        }
                    });

                    const currentBar = progressBars[swiper.activeIndex];
                    this.progressTimeline.to(currentBar, { 
                        scaleX: 1, 
                        duration: DURATION, 
                        ease: 'none',
                        onComplete: () => {
                            if (swiper.isEnd) {
                                this.mainSwiper.slideNext();
                            } else {
                                swiper.slideNext();
                            }
                        }
                    });

                    const allVideos = swiper.el.querySelectorAll('video');
                    allVideos.forEach(v => { v.pause(); v.currentTime = 0; });
                    
                    const activeSlide = swiper.slides[swiper.activeIndex];
                    const video = activeSlide.querySelector('video');
                    const muteBtn = swiper.el.closest('.story-slide-content').querySelector('.mute-story-btn');
                    
                    muteBtn.classList.toggle('hidden', !video);
                    if (video) {
                        video.muted = this.isMuted;
                        video.play().catch(e => console.error("Video play failed:", e));
                        this.updateMuteButton(muteBtn);
                    }
                }
                
                toggleMute(e) {
                    this.isMuted = !this.isMuted;
                    const video = this.activeNestedSwiper.slides[this.activeNestedSwiper.activeIndex]?.querySelector('video');
                    if (video) video.muted = this.isMuted;
                    this.updateMuteButton(e.currentTarget);
                }

                updateMuteButton(button) {
                    const icon = this.isMuted ? 'volume-x' : 'volume-2';
                    button.innerHTML = `<i data-feather="${icon}" class="w-6 h-6"></i>`;
                    feather.replace();
                }

                async shareStory(e) {
                    const storyIndex = e.currentTarget.closest('.swiper-slide').dataset.storyIndex;
                    const story = this.getStories()[storyIndex];
                    const shareData = {
                        title: story.card_title,
                        text: `Confira esta notícia: ${story.card_title}`,
                        url: window.location.href, // Idealmente, seria a URL direta do story
                    };
                    try {
                        if (navigator.share) {
                            await navigator.share(shareData);
                        } else {
                            alert('A função de compartilhar não é suportada neste navegador.');
                        }
                    } catch (err) {
                        console.error('Erro ao compartilhar:', err);
                    }
                }

                openModal(e) {
                    const storyIndex = e.currentTarget.closest('.swiper-slide').dataset.storyIndex;
                    const story = this.getStories()[storyIndex];
                    if (!story) return;
                    this.dom.modalImage.src = story.full_content_image || '';
                    this.dom.modalTitle.textContent = story.full_content_title || '';
                    this.dom.modalText.innerHTML = story.full_content_body || '';
                    this.dom.modal.classList.add('open');
                    if(this.progressTimeline) this.progressTimeline.pause();
                }

                closeModal() {
                    this.dom.modal.classList.remove('open');
                    if(this.progressTimeline) this.progressTimeline.resume();
                }
                
                formatTimeAgo(isoString) {
                    return dayjs(isoString).fromNow();
                }
            }

            const app = new App();
            app.init();
        });
    </script>
</body>
</html>
