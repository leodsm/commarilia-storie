<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ComMarília - Player de Story</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
  <header class="p-4 text-center font-bold text-2xl text-slate-800">
    Com<span class="text-orange-500">Marília</span>
  </header>
  <main class="max-w-5xl mx-auto px-4 py-8">
    <h2 class="text-2xl font-semibold mb-6 text-slate-700">Últimas Notícias</h2>
    <!-- O grid de notícias será preenchido dinamicamente -->
    <div id="news-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Exemplo de card enquanto carrega -->
        <div class="animate-pulse bg-slate-200 rounded-lg shadow-md h-64"></div>
        <div class="animate-pulse bg-slate-200 rounded-lg shadow-md h-64"></div>
        <div class="animate-pulse bg-slate-200 rounded-lg shadow-md h-64"></div>
    </div>
  </main>

  <!-- Modal/Player para exibir a matéria completa -->
  <div id="story-viewer" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center p-4 hidden z-50">
    <div class="relative w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-y-auto max-h-[90vh]">
      <div id="story-content" class="p-8">
        <!-- O conteúdo da matéria será inserido aqui -->
      </div>
      <button id="close-story" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
    </div>
  </div>

  <script>
    // Configuração do cliente Supabase
    const supabaseUrl = 'https://usagnogpivjvpkbjuxzr.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzYWdub2dwaXZqdnBrYmp1eHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzExMDksImV4cCI6MjA3MTIwNzEwOX0.AKUhd8Cx3S63xkzVnVTXnlz_kTnSfFhF38mVjNc-ee4';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Elementos da página
    const grid = document.getElementById('news-grid');
    const viewer = document.getElementById('story-viewer');
    const storyContent = document.getElementById('story-content');
    const closeBtn = document.getElementById('close-story');

    /**
     * Converte o JSON do Editor.js para HTML.
     * @param {object} editorData - O objeto de dados salvo pelo Editor.js.
     * @returns {string} - Uma string HTML formatada.
     */
    function renderEditorJsData(editorData) {
        let html = '';
        if (!editorData || !editorData.blocks) {
            return '<p>Conteúdo indisponível.</p>';
        }
        editorData.blocks.forEach(block => {
            switch (block.type) {
                case 'header':
                    html += `<h${block.data.level} class="text-2xl font-bold my-4">${block.data.text}</h${block.data.level}>`;
                    break;
                case 'paragraph':
                    html += `<p class="my-4 text-gray-700 leading-relaxed">${block.data.text}</p>`;
                    break;
                case 'list':
                    const listTag = block.data.style === 'ordered' ? 'ol' : 'ul';
                    html += `<${listTag} class="list-disc list-inside my-4 space-y-2">`;
                    block.data.items.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += `</${listTag}>`;
                    break;
                default:
                    console.warn('Tipo de bloco não suportado:', block.type);
            }
        });
        return html;
    }

    /**
     * Busca as matérias no Supabase e as renderiza na página.
     */
    async function fetchAndRenderStories() {
        // Busca na tabela 'stories', ordenando pelas mais recentes
        const { data: stories, error } = await supabase
            .from('stories')
            .select('*')
            .order('timestamp', { ascending: false });

        if (error) {
            console.error('Erro ao buscar matérias:', error);
            grid.innerHTML = `<p class="text-red-500 col-span-full">Não foi possível carregar as notícias. Tente novamente mais tarde.</p>`;
            return;
        }

        if (stories.length === 0) {
            grid.innerHTML = `<p class="text-gray-500 col-span-full">Nenhuma notícia encontrada.</p>`;
            return;
        }

        // Limpa o grid antes de adicionar os novos cards
        grid.innerHTML = '';

        stories.forEach(story => {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transition-transform duration-300 hover:scale-105';
            
            card.innerHTML = `
                <img src="${story.card_image}" alt="${story.card_title}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/EEE/31343C?text=Imagem';">
                <div class="p-4">
                    <span class="text-xs font-semibold uppercase" style="color:${story.category_color};">${story.category}</span>
                    <h3 class="text-lg font-semibold mt-1 text-slate-800">${story.card_title}</h3>
                </div>
            `;

            // Adiciona o evento de clique para abrir a matéria
            card.addEventListener('click', () => {
                // O conteúdo da matéria está salvo como um JSON string, então precisamos fazer o parse
                const contentData = JSON.parse(story.content);
                storyContent.innerHTML = renderEditorJsData(contentData);
                viewer.classList.remove('hidden');
            });

            grid.appendChild(card);
        });
    }

    // Funções para controlar o modal
    function closeViewer() {
        viewer.classList.add('hidden');
        storyContent.innerHTML = '';
    }

    closeBtn.addEventListener('click', closeViewer);
    
    // Fecha o modal se clicar fora do conteúdo
    viewer.addEventListener('click', (e) => {
        if (e.target === viewer) {
            closeViewer();
        }
    });

    // Inicia o carregamento das matérias quando a página carregar
    document.addEventListener('DOMContentLoaded', fetchAndRenderStories);
  </script>
</body>
</html>
