<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Conteúdo Integrado</title>
    
    <!-- Bibliotecas de Edição e UI -->
    <link href="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.css" rel="stylesheet">
    <script src="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js" defer></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

    <!-- Recursos Padrão -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons" defer></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .ql-editor { min-height: 150px; font-size: 1rem; }
        .page-editor-container .ql-editor { min-height: 80px; }
        
        /* Estilos para o Uppy Uploader */
        .uppy-Dashboard-inner { border-radius: 0.5rem; border: 2px dashed #d1d5db; }
        .uppy-Dashboard-AddFiles-title { font-size: 1rem; }

        /* Estilos para o SortableJS */
        .page-item { cursor: grab; }
        .page-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }

        /* Layout Principal */
        .editor-grid {
            display: grid;
            grid-template-columns: 300px 2fr 1fr; /* Sidebar | Formulário | Preview */
            height: 100vh;
        }
        
        /* Preview do Story */
        .story-preview-container {
            position: relative;
            width: 100%;
            max-width: 390px;
            aspect-ratio: 9 / 19.5;
            background-color: #111;
            border-radius: 2.5rem;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border: 10px solid black;
        }
        .text-shadow { text-shadow: 1px 1px 4px rgba(0,0,0,0.6); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 overflow-hidden">

    <div class="editor-grid">
        <!-- Coluna 1: Lista de Stories -->
        <aside class="bg-slate-100 border-r border-slate-200 flex flex-col h-full">
            <header class="p-4 border-b border-slate-200 flex-shrink-0">
                <h1 class="text-xl font-bold text-gray-800">Seus Stories</h1>
                <button id="add-post-btn" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Criar Novo Post</button>
            </header>
            <div id="stories-list" class="overflow-y-auto p-2">
                <p class="text-center text-gray-500 p-8">Carregando...</p>
            </div>
        </aside>

        <!-- Coluna 2: Formulário de Edição -->
        <main class="h-full overflow-y-auto">
            <form id="post-form" class="p-6 space-y-6">
                <input type="hidden" id="post-id">
                
                <!-- Dados Principais -->
                <div class="p-4 bg-white rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">Dados Principais</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="category" class="font-semibold text-sm text-gray-700 block mb-1">Categoria</label>
                            <input type="text" id="category" class="w-full p-2 border rounded-lg" placeholder="Ex: Marília">
                        </div>
                        <div>
                            <label for="categoryColor" class="font-semibold text-sm text-gray-700 block mb-1">Cor da Categoria</label>
                            <input type="color" id="categoryColor" class="w-full p-1 h-10 border rounded-lg" value="#F4A261">
                        </div>
                        <div>
                            <label for="cardTitle" class="font-semibold text-sm text-gray-700 block mb-1">Título do Card</label>
                            <input type="text" id="cardTitle" class="w-full p-2 border rounded-lg" placeholder="Título que aparece no card da notícia">
                        </div>
                        <div>
                            <label class="font-semibold text-sm text-gray-700 block mb-1">Imagem do Card</label>
                            <div id="uppy-card-image"></div>
                            <input type="hidden" id="cardImage">
                            <div class="mt-2">
                                <label for="cardImageUrl" class="text-sm font-medium text-gray-600">Ou insira a URL da imagem:</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="url" id="cardImageUrl" class="w-full p-2 border rounded-lg" placeholder="https://exemplo.com/imagem.jpg">
                                    <button type="button" class="set-image-url-btn bg-gray-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-700" data-target-input="cardImage" data-source-input="cardImageUrl">Aplicar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Matéria Completa -->
                <div class="p-4 bg-white rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">Matéria Completa</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="font-semibold text-sm text-gray-700 block mb-1">Imagem da Matéria</label>
                            <div id="uppy-full-content-image"></div>
                            <input type="hidden" id="fullContentImage">
                             <div class="mt-2">
                                <label for="fullContentImageUrl" class="text-sm font-medium text-gray-600">Ou insira a URL da imagem:</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="url" id="fullContentImageUrl" class="w-full p-2 border rounded-lg" placeholder="https://exemplo.com/imagem.jpg">
                                    <button type="button" class="set-image-url-btn bg-gray-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-700" data-target-input="fullContentImage" data-source-input="fullContentImageUrl">Aplicar</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="fullContentTitle" class="font-semibold text-sm text-gray-700 block mb-1">Título da Matéria</label>
                            <input type="text" id="fullContentTitle" class="w-full p-2 border rounded-lg" placeholder="Título completo da matéria">
                        </div>
                        <div>
                            <label class="font-semibold text-sm text-gray-700 block mb-1">Corpo da Matéria</label>
                            <div id="editor-container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Páginas do Story -->
                <div class="p-4 bg-white rounded-lg border">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">Páginas do Story (arraste para reordenar)</h3>
                    <div id="pages-container" class="space-y-4"></div>
                    <button type="button" id="add-page-btn" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Adicionar Página</button>
                </div>

                <!-- Publicação -->
                <div class="p-4 bg-white rounded-lg border sticky bottom-0 bg-opacity-90 backdrop-blur-sm">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">Publicação</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="status" class="font-semibold text-sm text-gray-700 block mb-1">Status</label>
                            <select id="status" class="w-full p-2 border rounded-lg">
                                <option value="published">Publicado</option>
                                <option value="draft">Rascunho</option>
                                <option value="scheduled">Agendado</option>
                            </select>
                        </div>
                        <div id="schedule-container" class="hidden">
                            <label for="timestamp" class="font-semibold text-sm text-gray-700 block mb-1">Data de Publicação</label>
                            <input type="datetime-local" id="timestamp" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="flex gap-2">
                             <button type="button" id="delete-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 hidden">Excluir</button>
                             <button type="button" id="save-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Salvar Alterações</button>
                        </div>
                    </div>
                </div>
            </form>
        </main>
        
        <!-- Coluna 3: Preview Visual -->
        <aside class="bg-slate-800 flex items-center justify-center p-8 h-full">
           <div class="story-preview-container">
                <div class="swiper-container w-full h-full">
                    <div class="swiper-wrapper" id="preview-swiper-wrapper">
                        <!-- Preview do Swiper será renderizado aqui -->
                    </div>
                </div>
                <div class="swiper-button-next text-white after:!text-2xl"></div>
                <div class="swiper-button-prev text-white after:!text-2xl"></div>
           </div>
        </aside>
    </div>

    <script>
        // Plugin Uppy para Supabase (deve ser global)
        class UppySupabase {
            constructor(uppy, options) { this.uppy = uppy; this.opts = options; this.id = 'UppySupabase'; this.type = 'uploader'; }
            install() { this.uppy.addUploader(this.upload.bind(this)); }
            uninstall() { this.uppy.removeUploader(this.upload.bind(this)); }
            async upload(fileIDs) {
                const { supabase, folder } = this.opts;
                for (const fileID of fileIDs) {
                    const file = this.uppy.getFile(fileID);
                    const fileName = `${folder}/${Date.now()}-${file.name}`;
                    this.uppy.setFileState(fileID, { progress: { uploadStarted: Date.now() } });
                    try {
                        const { data, error } = await supabase.storage.from('story-media').upload(fileName, file.data, { contentType: file.type, upsert: true });
                        if (error) throw error;
                        const { data: { publicUrl } } = supabase.storage.from('story-media').getPublicUrl(fileName);
                        this.uppy.setFileState(fileID, { progress: { uploadComplete: true, bytesUploaded: file.size } });
                        this.uppy.emit('upload-success', file, { uploadURL: publicUrl });
                    } catch (error) {
                        this.uppy.emit('upload-error', file, error);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURAÇÃO INICIAL ---
            const SUPABASE_URL = 'https://apdaldrcyugyjiwpodel.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwZGFsZHJjeXVneWppd3BvZGVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDc0NDAsImV4cCI6MjA3MTIyMzQ0MH0.UX0uAej52mEC3vsk-GSRHB7jNYm0N7MEN5-rBk-6e7A';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const dom = {
                form: document.getElementById('post-form'),
                postId: document.getElementById('post-id'),
                saveBtn: document.getElementById('save-btn'),
                deleteBtn: document.getElementById('delete-btn'),
                addPostBtn: document.getElementById('add-post-btn'),
                storiesList: document.getElementById('stories-list'),
                pagesContainer: document.getElementById('pages-container'),
                addPageBtn: document.getElementById('add-page-btn'),
                status: document.getElementById('status'),
                scheduleContainer: document.getElementById('schedule-container'),
                previewSwiperWrapper: document.getElementById('preview-swiper-wrapper'),
            };

            let mainEditor = null;
            let pageEditors = new Map();
            let uppyInstances = new Map();
            let sortable = null;
            let swiperInstance = null;
            let currentStoryId = null;

            // --- FUNÇÕES DE UTILIDADE ---
            const initializeQuill = (containerId, placeholder, content = '') => {
                const quill = new Quill(`#${containerId}`, {
                    theme: 'snow',
                    placeholder: placeholder,
                    modules: { toolbar: [['bold', 'italic', 'link']] }
                });
                if (content) quill.root.innerHTML = content;
                return quill;
            };

            // --- LÓGICA DO UPPY.JS ---
            function createUppyInstance(targetId, hiddenInputId) {
                if (uppyInstances.has(targetId)) uppyInstances.get(targetId).close();
                
                const uppy = new Uppy.Uppy({
                    debug: false, autoProceed: true,
                    restrictions: { maxNumberOfFiles: 1, allowedFileTypes: ['image/*', 'video/*'] },
                });
                uppy.use(Uppy.Dashboard, {
                    inline: true, target: `#${targetId}`, proudlyDisplayPoweredByUppy: false,
                    height: 150, note: 'Imagens ou vídeos (MP4)',
                });
                uppy.use(UppySupabase, { supabase: supabaseClient, folder: 'public' });

                uppy.on('upload-success', (file, response) => {
                    document.getElementById(hiddenInputId).value = response.uploadURL;
                    updatePreview();
                });
                
                uppyInstances.set(targetId, uppy);
                return uppy;
            }

            // --- LÓGICA DE CARREGAMENTO E SELEÇÃO ---
            async function loadStoriesList() {
                const { data, error } = await supabaseClient.from('stories').select('id, card_title, status').order('timestamp', { ascending: false });
                if (error) return dom.storiesList.innerHTML = `<p class="text-red-500 p-4">Erro ao carregar.</p>`;
                
                dom.storiesList.innerHTML = data.map(story => `
                    <div class="p-3 rounded-lg hover:bg-slate-200 cursor-pointer story-item ${story.id == currentStoryId ? 'bg-blue-600 text-white hover:bg-blue-700' : ''}" data-story-id="${story.id}">
                        <h3 class="font-semibold">${story.card_title || 'Story sem título'}</h3>
                        <p class="text-xs capitalize">${story.status}</p>
                    </div>
                `).join('');
            }
            
            async function loadStoryForEdit(storyId) {
                clearEditor(false); // Limpa sem recarregar a lista
                currentStoryId = storyId;
                
                const { data: post, error } = await supabaseClient
                    .from('stories').select(`*, story_pages ( * )`).eq('id', storyId).single();

                if (error || !post) {
                    alert('Post não encontrado.');
                    clearEditor();
                    return;
                }

                dom.postId.value = post.id;
                document.getElementById('category').value = post.category || '';
                document.getElementById('categoryColor').value = post.category_color || '#F4A261';
                document.getElementById('cardTitle').value = post.card_title || '';
                document.getElementById('cardImage').value = post.card_image || '';
                document.getElementById('fullContentImage').value = post.full_content_image || '';
                document.getElementById('fullContentTitle').value = post.full_content_title || '';
                if (mainEditor) mainEditor.root.innerHTML = post.full_content_body || '';
                dom.status.value = post.status || 'draft';
                if (post.status === 'scheduled') {
                    dom.scheduleContainer.classList.remove('hidden');
                    document.getElementById('timestamp').value = post.timestamp ? post.timestamp.slice(0, 16) : '';
                }

                if (post.story_pages) {
                    post.story_pages.sort((a, b) => a.order_index - b.order_index).forEach(page => addPageField(page));
                }
                
                dom.deleteBtn.classList.remove('hidden');
                updatePreview();
                loadStoriesList(); // Destaca o item selecionado na lista
            }

            function clearEditor(reloadList = true) {
                dom.form.reset();
                dom.postId.value = '';
                if (reloadList) currentStoryId = null;
                dom.pagesContainer.innerHTML = '';
                pageEditors.clear();
                uppyInstances.forEach(uppy => uppy.close());
                uppyInstances.clear();
                
                if (mainEditor) mainEditor.root.innerHTML = '';
                else mainEditor = initializeQuill('editor-container', 'Corpo da matéria...');

                createUppyInstance('uppy-card-image', 'cardImage');
                createUppyInstance('uppy-full-content-image', 'fullContentImage');
                
                if (sortable) sortable.destroy();
                sortable = new Sortable(dom.pagesContainer, { animation: 150, ghostClass: 'sortable-ghost', onEnd: updatePreview });
                
                dom.deleteBtn.classList.add('hidden');
                updatePreview();
                if (reloadList) loadStoriesList();
            }

            // --- LÓGICA DAS PÁGINAS ---
            function addPageField(pageData = {}) {
                const pageId = `page-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const editorId = `editor-${pageId}`;
                const uppyId = `uppy-${pageId}`;
                const hiddenInputId = `media-url-${pageId}`;
                const urlInputId = `url-input-${pageId}`;

                const pageDiv = document.createElement('div');
                pageDiv.className = 'p-4 bg-slate-50 rounded-lg border space-y-4 page-item';
                pageDiv.dataset.pageId = pageId;
                pageDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-500">Página</span>
                        <button type="button" class="remove-page-btn text-red-500 hover:text-red-700 font-bold">Remover</button>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-gray-700 block mb-1">Mídia da Página</label>
                        <div id="${uppyId}"></div>
                        <input type="hidden" class="page-media-url" id="${hiddenInputId}" value="${pageData.media_url || ''}">
                        <div class="mt-2">
                            <label for="${urlInputId}" class="text-sm font-medium text-gray-600">Ou insira a URL da mídia:</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="url" id="${urlInputId}" class="w-full p-2 border rounded-lg" placeholder="https://exemplo.com/midia.mp4">
                                <button type="button" class="set-image-url-btn bg-gray-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-700" data-target-input="${hiddenInputId}" data-source-input="${urlInputId}">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm text-gray-700 block mb-1">Texto da Página</label>
                        <div id="${editorId}" class="page-editor-container"></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="link-${pageId}" class="page-show-link h-4 w-4 rounded" ${pageData.show_full_link !== false ? 'checked' : ''}>
                        <label for="link-${pageId}" class="text-sm">Mostrar link para Matéria</label>
                    </div>`;
                dom.pagesContainer.appendChild(pageDiv);
                
                const newEditor = initializeQuill(editorId, 'Texto da página...', pageData.title || '');
                newEditor.on('text-change', updatePreview);
                pageEditors.set(editorId, newEditor);

                createUppyInstance(uppyId, hiddenInputId);
                
                pageDiv.querySelector('.remove-page-btn').addEventListener('click', () => {
                    pageDiv.remove();
                    pageEditors.delete(editorId);
                    const uppyInstance = uppyInstances.get(uppyId);
                    if (uppyInstance) uppyInstance.close();
                    uppyInstances.delete(uppyId);
                    updatePreview();
                });

                updatePreview();
            }

            // --- LÓGICA DO PREVIEW VISUAL ---
            function updatePreview() {
                const pages = Array.from(dom.pagesContainer.querySelectorAll('.page-item')).map(el => {
                    const pageId = el.dataset.pageId;
                    const mediaUrl = el.querySelector(`#media-url-${pageId}`).value;
                    const editor = pageEditors.get(`editor-${pageId}`);
                    const title = editor ? editor.root.innerHTML : '';
                    return { media_url: mediaUrl, title: title, media_type: mediaUrl.includes('.mp4') ? 'video' : 'image' };
                });

                if (pages.length === 0 || pages.every(p => !p.media_url)) {
                    dom.previewSwiperWrapper.innerHTML = `<div class="swiper-slide flex items-center justify-center text-white p-4 text-center"><p>Adicione páginas e mídias para visualizar o story.</p></div>`;
                    if (swiperInstance) swiperInstance.destroy(true, true);
                    swiperInstance = new Swiper('.swiper-container', { navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' } });
                    return;
                }

                dom.previewSwiperWrapper.innerHTML = pages.map(page => `
                    <div class="swiper-slide">
                        ${page.media_url ? (page.media_type === 'video'
                            ? `<video src="${page.media_url}" class="absolute inset-0 w-full h-full object-cover" muted loop autoplay playsinline></video>`
                            : `<img src="${page.media_url}" class="absolute inset-0 w-full h-full object-cover" />`
                        ) : '<div class="w-full h-full bg-black"></div>'}
                        <div class="absolute bottom-24 left-0 p-6 text-white z-10 w-full">
                            <div class="text-2xl font-bold leading-tight text-shadow">${page.title}</div>
                        </div>
                    </div>
                `).join('');

                if (swiperInstance) swiperInstance.destroy(true, true);
                swiperInstance = new Swiper('.swiper-container', {
                    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                });
            }
            
            // --- LÓGICA DE DADOS (CRUD) ---
            async function savePost() {
                const id = dom.postId.value;
                const statusValue = dom.status.value;
                let timestampValue = new Date().toISOString();
                if (statusValue === 'scheduled') {
                    const localDate = document.getElementById('timestamp').value;
                    if (!localDate) return alert('Por favor, defina uma data para agendamento.');
                    timestampValue = new Date(localDate).toISOString();
                }

                const pagesData = Array.from(dom.pagesContainer.querySelectorAll('.page-item')).map((el, index) => {
                    const pageId = el.dataset.pageId;
                    const mediaUrl = el.querySelector('.page-media-url').value;
                    const editor = pageEditors.get(`editor-${pageId}`);
                    const title = editor ? editor.root.innerHTML : '';
                    const showLink = el.querySelector('.page-show-link').checked;
                    return { media_url: mediaUrl, title, show_full_link: showLink, media_type: mediaUrl.includes('.mp4') ? 'video' : 'image', order_index: index };
                }).filter(p => p.media_url);

                const storyData = {
                    card_title: document.getElementById('cardTitle').value,
                    card_image: document.getElementById('cardImage').value,
                    category: document.getElementById('category').value,
                    category_color: document.getElementById('categoryColor').value,
                    full_content_title: document.getElementById('fullContentTitle').value,
                    full_content_image: document.getElementById('fullContentImage').value,
                    full_content_body: mainEditor.root.innerHTML,
                    status: statusValue,
                    timestamp: timestampValue,
                };
                
                if (id) storyData.id = id;

                dom.saveBtn.textContent = 'Salvando...';
                dom.saveBtn.disabled = true;

                const { data: storyResult, error: storyError } = await supabaseClient.from('stories').upsert(storyData).select().single();
                
                dom.saveBtn.textContent = 'Salvar Alterações';
                dom.saveBtn.disabled = false;

                if (storyError) { alert(storyError.message); return; }

                await supabaseClient.from('story_pages').delete().match({ story_id: storyResult.id });

                if (pagesData.length > 0) {
                    const pagesToInsert = pagesData.map(p => ({ ...p, story_id: storyResult.id }));
                    const { error: pagesError } = await supabaseClient.from('story_pages').insert(pagesToInsert);
                    if (pagesError) { alert(pagesError.message); return; }
                }

                alert('Post salvo com sucesso!');
                loadStoryForEdit(storyResult.id);
            }

            async function deletePost() {
                const id = dom.postId.value;
                if (!id || !confirm('Tem certeza que deseja excluir este post? Esta ação não pode ser desfeita.')) return;
                
                await supabaseClient.from('story_pages').delete().match({ story_id: id });
                const { error } = await supabaseClient.from('stories').delete().match({ id });
                
                if (error) { alert(error.message); return; }
                
                alert('Post excluído com sucesso.');
                clearEditor();
            }

            // --- EVENT LISTENERS ---
            dom.addPostBtn.addEventListener('click', () => clearEditor(true));
            dom.saveBtn.addEventListener('click', savePost);
            dom.deleteBtn.addEventListener('click', deletePost);
            dom.addPageBtn.addEventListener('click', () => addPageField());
            dom.status.addEventListener('change', () => {
                dom.scheduleContainer.classList.toggle('hidden', dom.status.value !== 'scheduled');
            });
            dom.storiesList.addEventListener('click', (e) => {
                const storyItem = e.target.closest('.story-item');
                if (storyItem) {
                    loadStoryForEdit(storyItem.dataset.storyId);
                }
            });
            
            dom.form.addEventListener('click', (e) => {
                if (e.target.classList.contains('set-image-url-btn')) {
                    const targetInputId = e.target.dataset.targetInput;
                    const sourceInputId = e.target.dataset.sourceInput;
                    const url = document.getElementById(sourceInputId).value;
                    if (url) {
                        document.getElementById(targetInputId).value = url;
                        updatePreview();
                    }
                }
            });

            dom.form.addEventListener('input', updatePreview);
            mainEditor = initializeQuill('editor-container', 'Corpo da matéria...');
            mainEditor.on('text-change', updatePreview);


            // --- INICIALIZAÇÃO ---
            clearEditor(true);
            feather.replace();
        });
    </script>
</body>
</html>
