<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Conteúdo - ComMarília</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
        }
        .drop-zone.dragover {
            background-color: #e9e9e9;
        }
        .drop-zone input[type="file"] {
            display: none;
        }
        /* Simple HTML Editor Styles */
        .simple-editor {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            min-height: 150px;
        }
        .editor-toolbar {
            border-bottom: 1px solid #d1d5db;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .editor-toolbar button {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
        }
         /* Preview Modal Styles */
        #preview-modal-content {
            width: 375px;
            height: 812px;
            max-width: 90vw;
            max-height: 90vh;
        }
        .text-shadow { text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Gerenciador de Conteúdo</h1>
            <p class="text-gray-600 mt-1">Adicione, edite e exporte as postagens do seu site.</p>
        </header>

        <!-- Seção de Upload e Download -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">1. Carregar e Exportar Dados</h2>
            <div class="grid md:grid-cols-2 gap-6 items-center">
                <div id="drop-zone" class="drop-zone p-8 text-center cursor-pointer transition-colors">
                    <input type="file" id="json-upload" accept=".json">
                    <p class="text-gray-500">Arraste e solte o arquivo <code class="bg-gray-200 px-1 rounded">posts.json</code> aqui, ou clique para selecionar.</p>
                    <p id="file-name" class="text-green-600 font-semibold mt-2"></p>
                </div>
                <button id="export-json-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Exportar posts.json
                </button>
            </div>
        </div>

        <!-- Seção da Tabela de Posts -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">2. Posts Atuais</h2>
                <button id="add-post-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Adicionar Novo Post
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Categoria</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Título Principal</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Páginas</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Publicação</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="posts-table-body" class="text-gray-700">
                        <tr>
                            <td colspan="5" class="text-center py-10 text-gray-500">Carregue um arquivo <code>posts.json</code> para começar.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Post -->
    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <form id="post-form" class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold">Adicionar Novo Post</h2>
                    <button type="button" id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                
                <input type="hidden" id="post-index">

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="category" class="font-semibold mb-1 block">Categoria</label>
                        <input type="text" id="category" list="category-list" placeholder="Selecione ou crie uma categoria" class="w-full p-3 border rounded-lg uppercase" required>
                        <datalist id="category-list"></datalist>
                    </div>
                    <div class="flex items-center gap-2">
                         <div class="flex-shrink-0">
                             <label class="font-semibold mb-1 block">Cor</label>
                            <input type="color" id="categoryColorValue" class="h-12 w-14 p-1 border rounded-lg cursor-pointer" value="#2563eb">
                        </div>
                        <div class="flex-grow">
                             <label class="font-semibold mb-1 block">Hex</label>
                            <input type="text" id="categoryColor" placeholder="#2563eb" class="w-full p-3 border rounded-lg" required>
                        </div>
                    </div>
                    <input type="text" id="cardTitle" placeholder="Título do Card" class="w-full p-3 border rounded-lg md:col-span-2" required>
                    <input type="url" id="cardImage" placeholder="URL da Imagem do Card" class="w-full p-3 border rounded-lg md:col-span-2" required>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold text-lg mb-3">Páginas do Story</h3>
                    <div id="pages-container" class="space-y-6"></div>
                    <button type="button" id="add-page-btn" class="mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Adicionar Página</button>
                </div>

                <div>
                    <h3 class="font-bold text-lg mb-3">Matéria Completa</h3>
                    <div class="space-y-4">
                        <input type="url" id="fullContentImage" placeholder="URL da Imagem da Matéria" class="w-full p-3 border rounded-lg" required>
                        <input type="text" id="fullContentTitle" placeholder="Título da Matéria" class="w-full p-3 border rounded-lg" required>
                        <div>
                            <label class="font-semibold mb-2 block">Corpo da Matéria</label>
                             <div class="editor-toolbar">
                                <button type="button" class="format-btn" data-format="bold"><i data-feather="bold"></i></button>
                                <button type="button" class="format-btn" data-format="italic"><i data-feather="italic"></i></button>
                                <button type="button" class="format-btn" data-format="insertUnorderedList"><i data-feather="list"></i></button>
                            </div>
                            <div id="fullContentBodyEditor" class="simple-editor" contenteditable="true"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Pré-visualização -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[60] flex items-center justify-center p-4 hidden">
        <div id="preview-modal-content" class="relative bg-gray-900 rounded-xl overflow-hidden shadow-2xl flex flex-col">
            <div id="preview-media-container" class="w-full h-full absolute inset-0"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
            
            <div class="absolute bottom-16 left-0 p-6 text-white z-10 w-full">
                <div id="preview-title" class="text-2xl font-bold leading-tight text-shadow"></div>
            </div>
            <button type="button" id="close-preview-btn" class="absolute top-4 right-4 text-white z-30 bg-black/30 rounded-full p-2">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let postsData = [];

        // --- Elementos da DOM ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('json-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const exportBtn = document.getElementById('export-json-btn');
        const addPostBtn = document.getElementById('add-post-btn');
        const tableBody = document.getElementById('posts-table-body');
        
        const modal = document.getElementById('post-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const postForm = document.getElementById('post-form');
        const addPageBtn = document.getElementById('add-page-btn');
        const pagesContainer = document.getElementById('pages-container');
        const colorPicker = document.getElementById('categoryColorValue');
        const colorText = document.getElementById('categoryColor');
        const categoryInput = document.getElementById('category');

        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');

        // --- Lógica de Upload ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (file.type !== 'application/json') {
                alert('Por favor, selecione um arquivo .json válido.');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    postsData = JSON.parse(e.target.result);
                    fileNameDisplay.textContent = `Arquivo carregado: ${file.name}`;
                    enableButtons();
                    renderTable();
                    updateCategoryList();
                } catch (error) {
                    alert('Erro ao processar o arquivo JSON. Verifique o formato.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function enableButtons() {
            exportBtn.disabled = false;
            addPostBtn.disabled = false;
        }

        // --- Lógica da Tabela ---
        function formatTimeAgo(isoString) {
            if (!isoString) return 'Data desconhecida';
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);

            if (seconds < 60) return `agora mesmo`;
            if (minutes < 60) return `${minutes} min atrás`;
            if (hours < 24) return `${hours}h atrás`;
            return `${days}d atrás`;
        }

        function renderTable() {
            if (postsData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">Nenhum post encontrado. Adicione um novo post para começar.</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = postsData.map((post, index) => `
                <tr class="border-b">
                    <td class="py-3 px-4">
                        <span class="text-white text-xs font-bold px-2 py-1 rounded-full" style="background-color: ${post.categoryColor};">${post.category}</span>
                    </td>
                    <td class="py-3 px-4 font-semibold">${post.cardTitle}</td>
                    <td class="py-3 px-4">${post.pages.length}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${formatTimeAgo(post.timestamp)}</td>
                    <td class="py-3 px-4">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-4" data-index="${index}">Editar</button>
                        <button class="delete-btn text-red-500 hover:text-red-700" data-index="${index}">Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        tableBody.addEventListener('click', (e) => {
            const index = e.target.dataset.index;
            if (e.target.classList.contains('edit-btn')) {
                openModalForEdit(index);
            }
            if (e.target.classList.contains('delete-btn')) {
                if (confirm(`Tem certeza que deseja excluir o post "${postsData[index].cardTitle}"?`)) {
                    postsData.splice(index, 1);
                    renderTable();
                }
            }
        });

        // --- Lógica do Modal e Editor Simples ---
        function openModalForAdd() {
            postForm.reset();
            document.getElementById('post-index').value = '';
            modalTitle.textContent = 'Adicionar Novo Post';
            pagesContainer.innerHTML = '';
            addPageField();
            document.getElementById('fullContentBodyEditor').innerHTML = '';
            modal.classList.remove('hidden');
        }

        function openModalForEdit(index) {
            const post = postsData[index];
            postForm.reset();
            document.getElementById('post-index').value = index;
            modalTitle.textContent = 'Editar Post';
            
            categoryInput.value = post.category;
            colorPicker.value = post.categoryColor;
            colorText.value = post.categoryColor;
            document.getElementById('cardTitle').value = post.cardTitle;
            document.getElementById('cardImage').value = post.cardImage;

            pagesContainer.innerHTML = '';
            post.pages.forEach(page => addPageField(page.mediaUrl, page.title));

            document.getElementById('fullContentImage').value = post.fullContent.image;
            document.getElementById('fullContentTitle').value = post.fullContent.title;
            document.getElementById('fullContentBodyEditor').innerHTML = post.fullContent.body || '';

            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        addPostBtn.addEventListener('click', openModalForAdd);
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        colorPicker.addEventListener('input', (e) => colorText.value = e.target.value);
        colorText.addEventListener('input', (e) => colorPicker.value = e.target.value);

        // --- Lógica de Categoria ---
        categoryInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        function updateCategoryList() {
            const categoryList = document.getElementById('category-list');
            if (!categoryList) return;

            const categories = [...new Set(postsData.map(post => post.category.toUpperCase()))];
            categoryList.innerHTML = categories.map(cat => `<option value="${cat}"></option>`).join('');
        }
        
        // --- Lógica do Editor Simples ---
        document.querySelectorAll('.format-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.execCommand(button.dataset.format, false, null);
            });
        });

        // --- Lógica das Páginas Dinâmicas ---
        addPageBtn.addEventListener('click', () => addPageField());

        function getYoutubeEmbedUrl(url) {
            let videoId = null;
            const shortsRegex = /youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/;
            const watchRegex = /youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/;
            
            let match = url.match(shortsRegex);
            if (match) videoId = match[1];
            else {
                match = url.match(watchRegex);
                if (match) videoId = match[1];
            }

            if (videoId) return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&playsinline=1&showinfo=0&modestbranding=1`;
            return null;
        }

        function addPageField(mediaUrl = '', title = '') {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-item relative flex flex-col gap-4 p-4 bg-gray-50 rounded-lg border';
            pageDiv.innerHTML = `
                <div class="flex justify-between items-start">
                     <div class="flex-grow">
                        <input type="text" class="page-media-url w-full p-2 border rounded-md" placeholder="URL da Imagem ou YouTube" value="${mediaUrl}" required>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                         <button type="button" class="preview-page-btn bg-indigo-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-indigo-600">Pré-visualizar</button>
                         <button type="button" class="remove-page-btn text-red-500 hover:text-red-700 font-bold text-2xl ml-2">&times;</button>
                    </div>
                </div>
                <div>
                    <label class="font-semibold mb-1 block">Texto do Storie</label>
                    <textarea class="page-title w-full p-2 border rounded-md" rows="3" placeholder="Texto que aparecerá no story">${title}</textarea>
                </div>
            `;
            pagesContainer.appendChild(pageDiv);
        }

        pagesContainer.addEventListener('click', (e) => {
            const pageItem = e.target.closest('.page-item');
            if (!pageItem) return;

            if (e.target.classList.contains('remove-page-btn')) {
                pageItem.remove();
            }

            if (e.target.classList.contains('preview-page-btn')) {
                const mediaUrl = pageItem.querySelector('.page-media-url').value;
                const title = pageItem.querySelector('.page-title').value;
                showPreview(mediaUrl, title);
            }
        });
        
        // --- Lógica da Pré-visualização ---
        function showPreview(mediaUrl, title) {
            const mediaContainer = document.getElementById('preview-media-container');
            mediaContainer.innerHTML = '';
            
            const youtubeEmbedUrl = getYoutubeEmbedUrl(mediaUrl);

            if (youtubeEmbedUrl) {
                mediaContainer.innerHTML = `<iframe src="${youtubeEmbedUrl}" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            } else {
                mediaContainer.innerHTML = `<img src="${mediaUrl || 'https://placehold.co/375x812/000000/FFFFFF?text=Sem+Mídia'}" class="w-full h-full object-cover" alt="Preview">`;
            }

            document.getElementById('preview-title').textContent = title;
            feather.replace();
            previewModal.classList.remove('hidden');
        }

        closePreviewBtn.addEventListener('click', () => {
            document.getElementById('preview-media-container').innerHTML = '';
            previewModal.classList.add('hidden');
        });

        // --- Lógica de Submissão do Formulário ---
        postForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const postIndex = document.getElementById('post-index').value;

            const pages = Array.from(pagesContainer.querySelectorAll('.page-item')).map(el => {
                const mediaUrl = el.querySelector('.page-media-url').value;
                const isVideo = !!getYoutubeEmbedUrl(mediaUrl);
                return {
                    mediaUrl: mediaUrl,
                    mediaType: isVideo ? 'video' : 'image',
                    title: el.querySelector('.page-title').value,
                };
            }).filter(p => p.mediaUrl && p.title);

            if (pages.length === 0) {
                alert('Adicione pelo menos uma página com texto e mídia ao story.');
                return;
            }

            const postData = {
                category: categoryInput.value,
                categoryColor: document.getElementById('categoryColor').value,
                cardImage: document.getElementById('cardImage').value,
                cardTitle: document.getElementById('cardTitle').value,
                timestamp: postIndex !== '' && postsData[postIndex] ? postsData[postIndex].timestamp : new Date().toISOString(),
                pages: pages,
                fullContent: {
                    image: document.getElementById('fullContentImage').value,
                    title: document.getElementById('fullContentTitle').value,
                    body: document.getElementById('fullContentBodyEditor').innerHTML
                }
            };

            if (postIndex === '') {
                postsData.unshift(postData);
            } else {
                postsData[postIndex] = postData;
            }

            renderTable();
            updateCategoryList();
            closeModal();
        });

        // --- Lógica de Exportação ---
        exportBtn.addEventListener('click', () => {
            const jsonString = JSON.stringify(postsData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'posts.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        feather.replace();
    });
    </script>
</body>
</html>
